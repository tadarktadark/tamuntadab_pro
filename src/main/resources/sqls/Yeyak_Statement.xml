<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tdtd.tmtd.model.mapper.YeyakDaoImpl">
	<select id="getGangeuisilCount" resultType="java.lang.Integer">
		SELECT COUNT(*)
			FROM GANGEUISIL_COMM
	        <choose>
	        	<when test="gacoSido != null">
	        		WHERE GACO_SIDO=#{gacoSido}
	        	</when>
	        	<when test="gacoSigungu != null">
	        		WHERE GACO_SIGUNGU=#{gacoSigungu}
	        	</when>
	        </choose>
	</select>
	<select id="getGangeuisilSidoList" resultType="java.lang.String">
		SELECT GACO_SIDO || '(' || COUNT(GACO_SIDO) || ')'
	        FROM GANGEUISIL_COMM
	        GROUP BY GACO_SIDO
	        ORDER BY GACO_SIDO
	</select>
	<select id="getGangeuisilSigunguList" resultType="java.lang.String">
		SELECT GACO_SIGUNGU || '(' || COUNT(GACO_SIGUNGU) || ')'
	        FROM GANGEUISIL_COMM
	        WHERE GACO_SIDO=#{gacoSido}
	        GROUP BY GACO_SIGUNGU
	</select>
	<select id="getGangeuisilList" resultType="gangeuisilVo">
		SELECT GACO_ID , GACO_NAME , GACO_JUSO , GACO_LAT , GACO_LON , GACO_OPEN , GACO_CLOSE
			FROM (SELECT GACO_ID , GACO_NAME , GACO_JUSO , GACO_LAT , GACO_LON , GACO_OPEN , GACO_CLOSE,
					ROW_NUMBER() OVER(ORDER BY GACO_ID) rn
					FROM GANGEUISIL_COMM
			        <choose>
			        	<when test="gacoSido != null">
			        		WHERE GACO_SIDO=#{gacoSido}
			        	</when>
			        	<when test="gacoSigungu != null">
			        		WHERE GACO_SIGUNGU=#{gacoSigungu}
			        	</when>
			        </choose>
					)
	        WHERE rn BETWEEN #{start} AND #{end}
	</select>
	<select id="getGangeuisilDetailList" resultType="gangeuisilVo">
		SELECT GAGA_ID, GAGA_GACO_ID AS GACO_ID, GAGA_NAME, GAGA_MAX, GAGA_HOUR_PRICE 
	        FROM GANGEUISIL_GAEBYEOL
	        WHERE GAGA_GACO_ID = #{gagaGacoId}
	</select>
	<select id="getYeyakDateList" resultType="yeyakVo">
		SELECT GAYE_YEYAK_DATE, GAYE_START_TIME , GAYE_HOURS 
	        FROM GANGEUISIL_YEYAK
	        WHERE GAYE_GAGA_ID = #{gayeGagaId}
	                AND GAYE_YEYAK_DATE > TO_CHAR(CURRENT_DATE ,'yyyyddmm')
	</select>
	<select id="getYeyakTimeList" resultType="yeyakVo">
		SELECT GAYE_ID, GAYE_GAGA_ID , GAYE_ACCOUNT_ID , GAYE_YEYAK_DATE , GAYE_START_TIME , GAYE_HOURS
	        FROM GANGEUISIL_YEYAK
	        WHERE GAYE_GAGA_ID = #{gayeGagaId}
	                AND GAYE_YEYAK_DATE = TO_CHAR(TO_DATE(#{gayeYeyakDate}),'yyyymmdd')
	                AND NOT GAYE_STATE = 'N'
	</select>
	<insert id="insertYeakInfo">
		INSERT INTO GANGEUISIL_YEYAK
	                        (GAYE_ID, GAYE_GAGA_ID, GAYE_ACCOUNT_ID, 
	                        GAYE_PHONE_NUMBER, GAYE_YEYAK_DATE, GAYE_START_TIME, 
	                        GAYE_HOURS, GAYE_STATE, 
                       	<if test="gayeClasId != null">                       	
	                        GAYE_CLAS_ID, 
                       	</if>
	                        GAYE_GYEOLJE_TYPE, GAYE_GYEOLJE_USER)
	        VALUES((SELECT 'YY'||TO_CHAR(CURRENT_DATE,'yyyymmdd')||LPAD(MAX(TO_NUMBER(SUBSTR(GAYE_ID,11)))+1,4,'0')
				        FROM GANGEUISIL_YEYAK
				        WHERE SUBSTR(GAYE_ID,1,10)='YY'||TO_CHAR(CURRENT_DATE,'yyyymmdd')), #{gayeGagaId}, #{gayeAccountId}, 
				        #{gayePhoneNumber}, #{gayeYeyakDate}, #{gayeStartTime}, 
				        #{gayeHours}, 'D' , 
				        <choose>
				        	<when test="gayeClasId != null">
				        		#{gayeClasId}, #{gayeGyeoljeType}, 	
				        	</when>
				        	<otherwise>
				        		'O',
				        	</otherwise>
				        </choose>
				        #{gayeGyeoljeUser})
		<selectKey keyProperty="gayeId" resultType="java.lang.String" order="AFTER">
			SELECT MAX(GAYE_ID)
	        	FROM GANGEUISIL_YEYAK
		</selectKey>
	</insert>
	<select id="getYeyakGyeoljeAcountIdList" resultType="java.lang.String">
		SELECT CLCH_ACCOUNT_ID 
	        FROM CLASS_CHAMYEOJA
	        WHERE CLCH_CLAS_ID =#{gayeClasId}
	                AND CLCH_STATUS = 'Y'
	                AND NOT CLCH_YEOKAL = 'I'
	</select>
	<insert id="insertYeakGyeoljeInfo">
		INSERT INTO GYEOLJE
	                (GYEO_ID, GYEO_GEUMAEK, GYEO_DAESANG_ID, 
	                GYEO_ACCOUNT_ID, GYEO_REGDATE, GYEO_STATUS)
	        VALUES((SELECT 'RE'||TO_CHAR(MAX(SUBSTR(GYEO_ID, 3))+1)
	        FROM GYEOLJE), #{gyeoGeumaek}, #{gyeoDaesangId}, 
	                #{gyeoAccountId}, CURRENT_DATE , 'W' )
	</insert>
	<select id="getMyYeyakList" resultType="yeyakVo">
		SELECT GAYE_ID, GAYE_GAGA_ID, GAYE_ACCOUNT_ID , GAYE_PHONE_NUMBER , GAYE_YEYAK_DATE , GAYE_START_TIME , GAYE_HOURS , GAYE_STATE , GAYE_CLAS_ID , GAYE_GYEOLJE_TYPE , GAYE_GYEOLJE_USER  
	        FROM GANGEUISIL_YEYAK
	        WHERE GAYE_GYEOLJE_USER LIKE '%'||#{accountId}||'%'
	</select>
	<update id="updateYeyakDelflag">
		UPDATE GANGEUISIL_YEYAK SET GAYE_STATE='N'
	        WHERE GAYE_ID=#{gayeId}
	</update>
</mapper>
